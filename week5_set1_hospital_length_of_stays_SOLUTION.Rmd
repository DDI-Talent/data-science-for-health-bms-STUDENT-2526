---
title: "Hospital Length of Stays"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(NHSRdatasets)
library(knitr)
library(gt)
```

# Load the data

*The data we'll be working with are part of the NHSRdatasets package*

```{r}
data("LOS_model")
?LOS_model
```

# Inspect

*Use your favourite functions to find out more about this dataset*

```{r}
glimpse(LOS_model)

```

This table has `r nrow(LOS_model)` rows and `r ncol(LOS_model)` columns.

# Tidying up Death

*Make Death a factor*

```{r}
LOS_model <- LOS_model %>% 
  mutate(Death = factor(Death))
```

*Recode Death levels*

```{r}
LOS_model <- LOS_model %>% 
  mutate(Death = factor(Death, levels = c(0,1), labels = c("survived", "died")))
```

# Summary table

*Create a summary table where each combination of Organisation and Death gets a count (n).*

```{r}
LOS_table_long <- LOS_model %>% 
  group_by(Organisation, Death) %>% 
  tally()
```

# Wide table

*Make a wide table with Dead and Survived as rows with a column for each Trust*

```{r}
LOS_table_wide <- LOS_table_long %>% 
  pivot_wider(names_from = Organisation, values_from = n)
```

# Trust table

*Another pivot with Survived and Died as columns, Trusts as rows. Also calculate the % survived for each Trust*

```{r}
LOS_table_wide_two_columns <- LOS_table_long %>% 
  pivot_wider(names_from = Death, values_from = n) %>% 
  mutate(Percent_survived = (survived/(survived + died))*100)
```

# Pretty table

*Make the wide table pretty with gt()*

```{r}
LOS_table_wide_two_columns %>% 
  ungroup() %>% 
  gt() %>% 
  tab_header(
    title = "Patient survival across NHS Trusts",
    subtitle = "Calculated from simulated data"
  ) %>% 
  tab_source_note(
    source_note = "Source: LOS_model dataset from the NHSRdatasets package"
  ) %>% 
  tab_spanner(
    label = "Patients",
    columns = c(survived, died)
  ) %>% 
  cols_label(
    Percent_survived = "Survival"
  ) %>% 
  fmt_percent(columns = c(Percent_survived), decimals = 0, scale_values = FALSE) %>% 
  opt_stylize()

```

# The end

*Let's knit to html to see your nice report (use the Knit button in RStudio, at the top of your editor window)*